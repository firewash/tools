<!DOCTYPE html>
<html>
<head>
    <title><%= title %></title>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href="/public/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="/public/bootstrap/bootstrap-theme.min.css">
    <script src="/public/js/jquery.js"></script>
    <script src="/public/bootstrap/bootstrap.min.js"></script>
    <link rel='stylesheet' href='/public/stylesheets/style.css'/>
</head>
<body>
<div class="page-header "  onclick="window.location.reload()">
    <h1><%= title %></h1>
</div>
<div class="page-wraper">
    <div class="panel panel-default">
        <div class="panel-heading">
            筛选条件
        </div>

        <form id="list_query" class="form-inline" action="#" method="get">
            <div class="form-group">
                <label for="name">URL模糊搜索</label>
                <input placeholder="模糊网址"   class="form-control" name="hazyurl" id="hazyurl" value=""/>

                <!--<label for="name" >时间范围</label>-->
                <!--<select class="form-control">-->
                    <!--<option value="1">-->
                        <!--今天-->
                    <!--</option>-->
                    <!--<option value="1">-->
                        <!--前两天-->
                    <!--</option>-->
                    <!--<option value="1">-->
                        <!--前一周-->
                    <!--</option>-->
                    <!--<option value="1">-->
                        <!--自定义-->
                    <!--</option>-->
                <!--</select>-->
            </div>
        </form>
    </div>

    <div class="panel panel-default">
        <div class="panel-heading">
            列表页面
        </div>

        <table id="capture_table" class="table">
            <thead>
                <tr>
                    <th>URL</th>
                    <th>执行时间</th>
                    <th>捕获完成时间</th>
                    <th>所属任务</th>
                    <th>所属人</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="capture_list">

            </tbody>
        </table>
    </div>

</div>

</body>

<script>
    var detail_url = "/diff/detail",
        capture_list_url = "/api/capture/list";

    function renderList(arr) {
        var list = $("#capture_list");
        list.html("");
        arr.forEach(function (item) {
            var timestamp_start_capture = item.timestamp_start_capture?(new Date(item.timestamp_start_capture)).toLocaleString():"",
                    timestamp_capture_complete = item.timestamp_capture_complete?(new Date(item.timestamp_capture_complete)).toLocaleString():"";;
            let html = `<tr>
                            <td>${item.url}</td>
                            <td>${timestamp_start_capture}</td>
                            <td>${timestamp_capture_complete}</td>
                            <td>${item.taskid}</td>
                            <td>null</td>
                            <td><a href="${detail_url}?_id=${item._id}" target="_blank">查看详情</a></td>
                        </tr>`
            list.append(html);
        })
    }

    function loadCaptureListData(condition){
        $.post(capture_list_url,condition,function(result){
            console.log(result);
            if(result.err){
                alert("something error. look console.");
            }else{
                renderList(result.data);
            }
        });
    }

    function bindEvent(){
        //查询 hazyurl
        $("#hazyurl").keyup(function(e){
            loadCaptureListData({
                hazy: $("#hazyurl").val()
            });
        })
    }

    function dataInit(){
        var hash = document.location.hash;
        var condition = {};
        if(hash){
            var arr = hash.substr(1).split("&");
            arr.forEach(function(item){
                var t = item.split("=");
                if(t.length==2)condition[t[0]]=t[1];
            })
        }
        loadCaptureListData(condition);
    }

    $(function () {
        dataInit();
        bindEvent();
    })

</script>

</html>
